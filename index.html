<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>hey taxi!</title>

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO"
      crossorigin="anonymous"
    ></script>
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body onload="getLocation()">
    <nav>
      <div>
        <a href=""><button class="logo">hey!</button></a>
      </div>
      <div class="search" style="display: none">
        <input
          type="text"
          id="searchBar"
          placeholder="..."
          onclick="resizeBar()"
        />
        <button
          class="btn text-center d-flex flex-center justify-content-space-around"
          id="searchBut"
        >
          <img src="./pics/search.png" alt="" />
        </button>
      </div>
      <div class="user">
        <div id="username">kian</div>
        <div>
          <a href=""
            ><img src="./pics/Untitled.png" alt="user-img" id="user-img"
          /></a>
        </div>
      </div>
    </nav>
    <div class="space"></div>
    <div>
      <div class="col" id="map-container">
        <button class="btn" id="begin" onclick="fadeButton()">
          <img src="./pics/centerMe.png" alt="" />
        </button>
        <div class="col-12" id="map"></div>
      </div>
    </div>
    <div style="padding: 20px; text-align: center">
      <h2 style="color: #c0c0c8">Choose an Account</h2>
      <button class="btn" id="openAll" onclick="adminLogin()">Open All</button>
      <div
        id="accountsGrid"
        style="
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
          gap: 5px;
          margin-top: 20px;
        "
      >
        <button class="btn account-btn" onclick="showSignup()">
          Account 1
        </button>
        <button class="btn account-btn" onclick="showSignup()">
          Account 2
        </button>
        <button class="btn account-btn" onclick="showSignup()">
          Account 3
        </button>
      </div>
    </div>
    <div class="container mt-3">
      <form class="w-50 mx-auto" id="admin-login-form" style="display: none">
        <h1 class="text-center" id="login/sign">Login</h1>
        <div class="mb-3">
          <label for="username-input" class="form-label">Username</label>
          <input
            type="text"
            class="form-control"
            id="username-input"
            placeholder="Username"
            name="username"
            required
          />
        </div>
        <div class="mb-3">
          <label for="password-input" class="form-label">Password</label>
          <input
            type="password"
            class="form-control"
            id="password-input"
            placeholder="Password"
            name="password"
            required
          />
        </div>
        <button type="submit" class="btn btn-primary w-100">Login</button>
      </form>
    </div>
    <div class="container mt-3">
      <form class="w-50 mx-auto" id="login-form" style="display: none">
        <h1 class="text-center" id="login/sign">Login</h1>
        <div class="mb-3">
          <label for="username-input" class="form-label">Username</label>
          <input
            type="text"
            class="form-control"
            id="username-input"
            placeholder="Username"
            name="username"
            required
          />
        </div>
        <div class="mb-3">
          <label for="password-input" class="form-label">Password</label>
          <input
            type="password"
            class="form-control"
            id="password-input"
            placeholder="Password"
            name="password"
            required
          />
        </div>
        <button type="submit" class="btn btn-primary w-100">Login</button>
        <p class="mt-3 text-center">
          Don't have an account?
          <strong class="strong" onclick="showSignup()"> click here</strong>
        </p>
      </form>
      <form class="w-50 mx-auto" id="signup-form" style="display: none">
        <h1 class="text-center" id="login/sign">Signup</h1>
        <div class="mb-3">
          <label for="username-input" class="form-label">Username</label>
          <input
            type="text"
            class="form-control"
            id="username-input"
            placeholder="Username"
            name="username"
            required
          />
        </div>
        <div class="mb-3">
          <label for="email-input" class="form-label">email</label>
          <input
            type="email"
            class="form-control"
            id="email-input"
            placeholder="email"
            name="email"
            required
          />
        </div>
        <div class="mb-3">
          <label for="password-input" class="form-label">Password</label>
          <input
            type="password"
            class="form-control"
            id="password-input"
            placeholder="Password"
            name="password"
            required
          />
        </div>

        <div class="mb-3">
          <label for="repeat-password-input" class="form-label"
            >repeat password</label
          >
          <input
            type="repeat-password"
            class="form-control"
            id="repeat-password-input"
            placeholder="repeat-password"
            name="repeat-password"
            required
          />
        </div>
        <button type="submit" class="btn btn-primary w-100">Sign in</button>
        <p class="mt-3 text-center">
          already have an account?
          <strong class="strong" onclick="showLogin()"> click here</strong>
        </p>
      </form>
    </div>
    <div class="row bg-dark mt-3 py-3" id="footer">
      <div class="row text-center text-white">
        <p class="display-7">a website by kian ghaffarian and omid hamidian</p>
        <small class="text-white-30"> thanks to mr.mahmoodzadeh</small>
      </div>
    </div>
    <script>
      function showSignup() {
        document.getElementById("admin-login-form").style.display = "none";
        document.getElementById("login-form").style.display = "none";
        document.getElementById("signup-form").style.display = "block";
        document.getElementById("login/sign").innerText = "Sign up";
        window.scrollTo(0, document.body.scrollHeight);
      }
      function showLogin() {
        document.getElementById("admin-login-form").style.display = "none";
        document.getElementById("signup-form").style.display = "none";
        document.getElementById("login-form").style.display = "block";
        document.getElementById("login/sign").innerText = "Login";
        window.scrollTo(0, document.body.scrollHeight);
      }
      function adminLogin() {
        document.getElementById("login-form").style.display = "none";
        document.getElementById("signup-form").style.display = "none";
        document.getElementById("admin-login-form").style.display = "block";
        document.getElementById("login/sign").innerText = "Admin Login";
        window.scrollTo(0, document.body.scrollHeight);
      }
    </script>

    <script>
      let locPopUp;

      function fadeButton() {
        document.getElementById("begin").style.top = "75%";
        document.getElementById("begin").style.left = "90%";
        document.getElementById("map-container").style.display = "block";
        document.getElementById("map").style.height = "75vh";

        navigator.geolocation.getCurrentPosition(
          (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            marker.setLatLng([lat, lng]).addTo(map);
            map.setView([lat, lng], 15);
            marker.bindPopup("You are here").openPopup();
          },
          () => {
            alert("Could not get your location.");
          }
        );

        setTimeout(() => {
          map.invalidateSize();
        }, 500);
      }
      var map = L.map("map");
      L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution:
          '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      }).addTo(map);
      map.setView([36.2972, 59.6067], 15);
      let marker = L.marker([36.2972, 59.6067]);
      marker.bindPopup(locPopUp).openPopup();
    </script>

    <script>
      let loggedInUser = null;

      async function loadUsers() {
        const res = await fetch("Users.json");
        return await res.json();
      }

      function saveLocationForUser(username, lat, lng) {
        console.log(`Saving location for ${username}: (${lat}, ${lng})`);
        // Needs backend to write this back to Users.json
      }

      async function handleLogin(event, isAdmin = false) {
        event.preventDefault();

        const username = document.querySelector("#username-input").value.trim();
        const password = document.querySelector("#password-input").value.trim();

        const users = await loadUsers();

        const userFound = users.find((user) => {
          const keys = Object.keys(user);
          const uname = user[keys.find((k) => k.includes("username"))];
          const pass = user[keys.find((k) => k.includes("password"))];
          return uname === username && pass === password;
        });

        if (isAdmin) {
          if (username === "admin" && password === "admin123") {
            alert("Admin logged in!");
            showAllUserLocations(users);
          } else {
            alert("Invalid admin credentials");
          }
        } else {
          if (userFound) {
            loggedInUser = username;
            navigator.geolocation.getCurrentPosition((position) => {
              const { latitude, longitude } = position.coords;
              saveLocationForUser(username, latitude, longitude);
              marker.setLatLng([latitude, longitude]).addTo(map);
              map.setView([latitude, longitude], 15);
              marker.bindPopup("You are here").openPopup();
            });
            alert(`Welcome, ${username}!`);
          } else {
            alert("User not found or wrong password");
          }
        }
      }

      function showAllUserLocations(users) {
        users.forEach((user) => {
          const uname =
            user[Object.keys(user).find((k) => k.includes("username"))];
          const locKey = Object.keys(user).find((k) => k.includes("location"));
          const location = user[locKey];

          if (location && location.includes(",")) {
            const [lat, lng] = location.split(",").map(Number);
            L.marker([lat, lng]).addTo(map).bindPopup(`${uname}'s location`);
          }
        });
      }

      // Attach submit handlers
      document
        .querySelector("#login-form")
        ?.addEventListener("submit", (e) => handleLogin(e));
      document
        .querySelector("#admin-login-form")
        ?.addEventListener("submit", (e) => handleLogin(e, true));
    </script>
  </body>
</html>
