<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>hey taxi! Car Tracker</title>

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO"
      crossorigin="anonymous"
    ></script>
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <nav class="col p-2 g-3 navbar">
      <div class="col-2">
        <a href=""><button class="logo">hey!</button></a>
      </div>

      <div class="col user col-2">
        <div class="p text-white user-username">Car Tracker</div>
        <div>
          <a href="#"
            ><img src="./pics/Untitled.png" alt="user-img" id="user-img"
          /></a>
        </div>
      </div>
    </nav>
    <div class="space"></div>
    <div>
      <div class="col" id="map-container">
        <div class="col-12" id="map"></div>
      </div>
    </div>
    <div class="location-list-container">
      <h2>Recent Visited Locations</h2>
      <ul id="visitedLocationsList">
        <li>Loading locations...</li>
      </ul>
    </div>
    <div class="row footer bg-dark mt-3 py-3 border-round" id="footer">
      <div class="row text-center text-white">
        <p class="display-7">a website by kian ghaffarian and omid hamidian</p>
        <small class="text-white-30"> special thanks to mr.mahmoodzadeh</small>
      </div>
    </div>

    <img src="./pics/doom.png" alt="" class="music-image" id="audioImage" />
    <audio id="myAudio" src="./doom.mp3"></audio>

    <script>
      let map;
      let carMarker;
      let polyline;
      // Default initial view (Imam Reza Holy Shrine, Mashhad)
      let initialMapCenter = [36.2972, 59.6067];

      // Initialize the map
      map = L.map("map").setView(initialMapCenter, 15);

      L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution:
          '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      }).addTo(map);

      // Create a marker for the car's current location
      // Using an empty point initially, will be updated by fetchAndDisplayLocations
      carMarker = L.marker(initialMapCenter).addTo(map);
      carMarker.bindPopup("Car's Current Location").openPopup();

      // Cache for geocoded locations to reduce API calls
      const geocodeCache = {};

      // Function to perform reverse geocoding using OpenStreetMap Nominatim
      async function reverseGeocode(latitude, longitude) {
        const cacheKey = `${latitude.toFixed(6)},${longitude.toFixed(6)}`;
        if (geocodeCache[cacheKey]) {
          return geocodeCache[cacheKey]; // Return from cache if available
        }

        const nominatimUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=18&addressdetails=1`;

        try {
          // Important: Nominatim asks for a polite user-agent.
          // In a browser environment, fetch typically handles this, but for a server-side
          // request or if you were making many requests quickly, you'd need to add headers.
          // For frontend usage, this is generally fine for moderate use.
          const response = await fetch(nominatimUrl);
          const data = await response.json();
          const locationName = data.display_name || "Unknown Location";
          geocodeCache[cacheKey] = locationName; // Store in cache
          return locationName;
        } catch (error) {
          console.error("Error during Nominatim reverse geocoding:", error);
          return "Error Fetching Location Name";
        }
      }

      // Function to fetch and display car locations
      async function fetchAndDisplayLocations() {
        try {
          const response = await fetch("/locations"); // Fetch from your Flask backend
          const locations = await response.json();

          if (locations.length === 0) {
            console.log("No car location data available.");
            document.getElementById("visitedLocationsList").innerHTML =
              "<li>No location history available.</li>";
            return;
          }

          // Extract coordinates for the polyline
          const latlngs = locations.map((loc) => [loc.latitude, loc.longitude]);

          // Update the polyline
          if (polyline) {
            map.removeLayer(polyline); // Remove old polyline if exists
          }
          polyline = L.polyline(latlngs, { color: "red", weight: 5 }).addTo(
            map
          );

          // Update the car's current location marker to the latest point
          const latestLocation = locations[locations.length - 1];
          carMarker.setLatLng([
            latestLocation.latitude,
            latestLocation.longitude,
          ]);
          carMarker.setPopupContent(
            `Car's Current Location<br>(${latestLocation.latitude.toFixed(
              4
            )}, ${latestLocation.longitude.toFixed(
              4
            )})<br>Last Updated: ${new Date(
              latestLocation.timestamp
            ).toLocaleString()}`
          );

          // Optionally center the map on the latest location when it moves significantly
          // map.setView([latestLocation.latitude, latestLocation.longitude], map.getZoom());

          console.log("Map updated with new locations and polyline.");

          // --- Update the visited locations list ---
          const locationsListElement = document.getElementById(
            "visitedLocationsList"
          );
          locationsListElement.innerHTML = ""; // Clear previous list

          // To avoid too many API calls, geocode only the last few unique locations
          const locationsToGeocode = [];
          const uniqueLocations = new Set(); // Use a Set to track unique (lat,lng) pairs

          // Iterate from newest to oldest, adding unique locations
          for (
            let i = locations.length - 1;
            i >= 0 && locationsToGeocode.length < 10;
            i--
          ) {
            const loc = locations[i];
            const locString = `${loc.latitude.toFixed(
              4
            )},${loc.longitude.toFixed(4)}`; // Rough uniqueness
            if (!uniqueLocations.has(locString)) {
              locationsToGeocode.unshift(loc); // Add to the beginning to maintain chronological order
              uniqueLocations.add(locString);
            }
          }

          if (locationsToGeocode.length === 0) {
            locationsListElement.innerHTML =
              "<li>No unique recent locations to display.</li>";
          } else {
            for (const loc of locationsToGeocode) {
              const locationName = await reverseGeocode(
                loc.latitude,
                loc.longitude
              );
              const listItem = document.createElement("li");
              listItem.innerHTML = `<strong>${new Date(
                loc.timestamp
              ).toLocaleString()}</strong>: ${locationName} <em>(${loc.latitude.toFixed(
                4
              )}, ${loc.longitude.toFixed(4)})</em>`;
              locationsListElement.appendChild(listItem);
            }
          }
          // --- End New List Update ---
        } catch (error) {
          console.error("Error fetching car locations:", error);
        }
      }

      // Initial load of locations
      fetchAndDisplayLocations();

      // Refresh locations every 10 seconds (adjust as needed)
      setInterval(fetchAndDisplayLocations, 10000); // 10 seconds for real-time like updates

      // Music player script (kept as is)
      const audio = document.getElementById("myAudio");
      const image = document.getElementById("audioImage");

      let isPlaying = false;

      image.addEventListener("click", () => {
        if (!isPlaying) {
          audio.play();
        } else {
          audio.pause();
          audio.currentTime = 0;
        }
        isPlaying = !isPlaying;
      });

      audio.addEventListener("ended", () => {
        isPlaying = false;
      });
    </script>
  </body>
</html>
